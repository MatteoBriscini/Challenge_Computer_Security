# mission7
## Goal and instructions
Connect to bin.chall.necst.it port 22 via SSH as user [USERNAME]. You will find the files in /home/[USERNAME]/mission7.

Your goal is to read the file flag with the privileges of the group that owns the vulnerable binary.
## Vulnerability presentation 
Spectre is a hardware security vulnerability discovered by Jann Horn from [Google project zero](https://googleprojectzero.blogspot.com/) which allows attackers to access private data at the CPU level. <br>
Specter exploits speculative execution to load private data in the cache memory and guess the secret value with a time-based attack.
You can find some information by:
* watching this [video](https://www.youtube.com/watch?v=q3-xCvzBjGs)
* on the [paper of the attack](https://spectreattack.com/spectre.pdf)

## Compiled options
The executable program is compiled in 64bit, the stack isn't executable and the canary is inactive.
```
gcc -std=c99 -O3 -Wall -g -o mission7 mission7.c
```
## Code overview
The vulnerable program loads the flag from the memory before requesting 2 user inputs, all the data are saved in the same memory structure and so in a contiguous memory space.
```
typedef struct _perm {
    unsigned int key[MAX_SIZE];     //user input
    char cypertext[MAX_SIZE];  
    char plaintext[MAX_SIZE];       //user input
    char flag[FLAG_SIZE];
} Permutation;
```
The normal operation of the program requires the user to use the key to perform permutation in the plaintext and it will return the cypertext. Both plaintext and cypertext have a fixed length of 4096 characters.
```
// Permutating
for (int i = 0; i < key_len; i++) {
    _mm_clflush(&plain_len);
    _mm_mfence();
    unsigned int plain_pos = perm.key[i];
    if (plain_pos < plain_len) {        //true for speculative execution
        size_t check_len = strlen(&check_boxes[perm.plaintext[plain_pos] * BOX_SIZE]);
        check_boxes[(perm.plaintext[plain_pos] * BOX_SIZE) + check_len] = perm.plaintext[plain_pos];
        perm.cypertext[i] = perm.plaintext[plain_pos];
    }
}
```
However, due to speculative execution, the CPU will execute the instruction inside the if branch even if plain_pos > plain_len allowing the attacker to successfully perform permutation with characters outside of the plaintext (from the flag). When the if condition is evaluated the instructions are Additionally, the program provides a function that returns 256 memory access time, for debugging reasons.
```
if (getenv("DEBUG")) {
    // Measuring times
    for (int i = 0; i < 256; i++) {
        unsigned long long time_taken = measure_access_time(&check_boxes[i * BOX_SIZE]);
        printf("Access time for index %d: %llu cycles\n", i, time_taken);
    }
}
```
## Solution