# mission5 ~ xor vulnerability
## Goal and instructions
Connect to bin.chall.necst.it port 22 via SSH as user [USERNAME]. You will find the files in /home/[USERNAME]/mission5.

Your goal is to read the file flag with the privileges of the group that owns the vulnerable binary.
## compiled options
The executable program is compiled in 64bit, the stack is not executable and the canary is active.
```
gcc -no-pie -g3 -O0 -o mission5 mission5.c
```
## Code overview
Due to controls on the input length in the challenge code, it is not possible to overflow the input.
```
if (read(0, message, 40 + 8) <= 0) {
    fprintf(stderr, "Read failed!");
    exit(-1);
}
```
However, the code will concatenate the input string with a single string chosen from a list by the user, making it possible to use this string to perform a buffer overflow.
```
//Concat message with signature
strcat(message, "\n\t");
strcat(message, signatures[choice]);
```
Also, a shell code is loaded in a known address on the stack during the executable start.
```
void gift()
{
    void* addr = (void*)0x2121733000;
    size_t shellcode_len = strlen(shellcode);

    // Allocate executable memory
    void* shellcode_mem = mmap(addr, shellcode_len, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANONYMOUS | MAP_PRIVATE | MAP_FIXED, -1, 0);

    if (shellcode_mem == MAP_FAILED) {
        perror("mmap failed");
        exit(EXIT_FAILURE);
    }

    // Add 0x40 bytes of nop sled, just in case
    memset(shellcode_mem, 0x90, 0x40);

    // Copy the shellcode into the allocated memory
    memcpy(shellcode_mem + 0x40, shellcode, 137);
}
```
During the execution, the user can swap 2 characters in the provided string, for performance reasons the swap is implemented using XOR operator.
```
// Efficient implementation of swap between two elements using XOR
void swap(char *a, char *b)
{
    *a ^= *b;
    *b ^= *a;
    *a ^= *b;
}
```
## Solution
The shell code is saved in the address 0x2121733000, between all the choosable strings we can find the string *"90s!!"*, the hexadecimal code for this string is 0x3930732121 (0x2121733039 little endian), using this string in overflow we can jump inside the NOP Sled.
this practice will change the last 2 characters of the canary, fortunately, those characters are both zero, and we can use the XOR operator on the same pose (40) in the string to write zero again in the canary.
> **note:** we can fill the input string with 40 random characters.
